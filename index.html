<!DOCTYPE html>
<html>
<head>
<style>
/* Columns */
* {
  box-sizing: border-box;
}
.column {
  float: left;
  width: 50%;
  padding: 10px;
  overflow: hidden;
  height: 300px;
}
.row:after {
  content: "";
  display: table;
  clear: both;
}
.ship_name_class {
  line-height: 1px;
}
#combat_log_column {
  line-height: 1px;
}
h3 {
  padding:0px;
  margin:0px;
}
</style>
</head>
<body>
<div class="row">
<div class="column">
<h3 id="side_1_name_id"></h3>
<div>
<p id="side_1_ship_list"></p>
</div>
<h3 id="side_2_name_id"></h3>
<div>
<p id="side_2_ship_list"></p>
</div>
<button type="button" onclick="run_hour()">Do hour</button>
</div>
<div class="column">
<h3>Combat log</h3>
<div id="combat_log_column">
</div>
</div>
</div>
<div class="row">
<div class="column">
<h3>Add a ship</h3>
<label>Name:</label>
<input type="text" id="name_text"> <br>
<label>Speed:</label>
<input type="text" id="speed_text"> <br>
<label>Health:</label>
<input type="text" id="health_text"> <br>
<label>Side:</label>
<select id="side_choice">
<option value="1">1</option>
<option value="2">2</option>
</select><br>
<button type="button" onclick="add_ship(document.getElementById('name_text').value, document.getElementById('speed_text').value, document.getElementById('health_text').value, document.getElementById('side_choice').value)">Add</button>
</div>
<div class="column">
<p>123</p>
</div>
</div>
<script>
// Define classes
class Side {
	constructor(id, name, ships) {
    	this.id = id;
    	this.name = name;
    	this.ships = ships;
    }
}
class Ship {
	constructor(name, speed, health, weapons) {
    	this.name = name;
        this.speed = speed;
        this.health = health;
        this.weapons = weapons;
        this.light_attack = 0;
        this.torpedo_attack = 0;
        this.visibility = 10;
        this.profile = (100 * this.visibility)/(0.5 * this.speed + 20);
        this.calculate_attack_values();
    }
    calculate_attack_values() {
    	for (let weapon of this.weapons) {
        	this.light_attack += weapon.light_attack;
            this.torpedo_attack += weapon.torpedo_attack;
        }
    }
}
class Weapon {
	constructor(name, hit_profile, light_attack, torpedo_attack) {
    	this.name = name;
        this.hit_profile = hit_profile;
        this.light_attack = light_attack;
        this.torpedo_attack = torpedo_attack;
    }
}

// Define functions
function get_random(list) {
	return list[Math.floor((Math.random()*list.length))];
}
function run_hour() {
	// Ships fire
	for (let ship of side_1.ships) {
    	let target = get_random(side_2.ships);
        fire_at_target(ship, target);
    }
    for (let ship of side_2.ships) {
    	let target = get_random(side_1.ships);
        fire_at_target(ship, target);
    }
	// Remove sunken ships
    for (let s of sides) {
      for (let i = 0; i < s.ships.length; i++) {
        if (s.ships[i].health <= 0) {
            // Janky but works
            s.ships.splice(i, 1);
            i -= 1;
            continue;
        }
      }
    }
	// Display ship information
	display_ships()
}

function fire_at_target(ship, target) {
	let hit_chance = 0.1;
    for (weapon of ship.weapons) {
      if (target.health > 0 && Math.random() < hit_chance * Math.min((target.profile/weapon.hit_profile) ** 2, 1)) {
        target.health -= weapon.light_attack;
        target.health -= weapon.torpedo_attack;
        if (target.health <= 0) {
          add_p_to_beginning("combat_log_column", ship.name + "'s " + weapon.name + " sunk " + target.name);
        } else {
          add_p_to_beginning("combat_log_column", ship.name + "'s " + weapon.name + " hit " + target.name);
        }
      }
    }
}

function display_ships() {
  let paras = document.getElementsByClassName("ship_name_class");
  while(paras[0]) {
    paras[0].parentNode.removeChild(paras[0]);
  }
  for(let s of sides) {
    for (let i = 0; i < s.ships.length; i++) {
      let para = document.createElement("p");
      para.className = "ship_name_class";
      let node = document.createTextNode(s.ships[i].name + " " + s.ships[i].health);
      para.appendChild(node);
      let element = document.getElementById("side_1_ship_list");
      if (s.id == 1) {
      	element = document.getElementById("side_1_ship_list");
      } else if (s.id == 2) {
      	element = document.getElementById("side_2_ship_list");
      }
      element.appendChild(para);
    }
  }
}

function add_p(id, text) {
	let para = document.createElement("p");
    let node = document.createTextNode(text);
    para.appendChild(node);
    let element = document.getElementById(id);
    element.appendChild(para);
}

function add_p_to_beginning(id_container, text) {
	let para = document.createElement("p");
    let node = document.createTextNode(text);
    para.appendChild(node);
    let element = document.getElementById(id_container);
    element.insertBefore(para, element.firstChild);
}

function add_ship(name, speed, health, side_id) {
	sides[side_id-1].ships.push(new Ship(name, speed, health, [light_guns,light_guns,light_guns,light_guns,light_guns,torpedoes,torpedoes]));
    display_ships();
}

// Define weaposn
const light_guns = new Weapon("Light Gun", 45, 6, 0);
const torpedoes = new Weapon("Torpedoes", 145, 0, 10);
const side_1_ships = [];
const Fletcher = new Ship("Fletcher", 37, 50, [light_guns,light_guns,light_guns,light_guns,light_guns,torpedoes,torpedoes]);
side_1_ships.push(Fletcher);
const side_2_ships = [];
const Fubuki = new Ship("Fubuki", 38, 50, [light_guns,light_guns,light_guns,light_guns,light_guns,light_guns,torpedoes]);
const Ayanami = new Ship("Ayanami", 38, 50, [light_guns,light_guns,light_guns,light_guns,light_guns,light_guns,torpedoes]);
side_2_ships.push(Fubuki, Ayanami);
const side_1 = new Side(1, "America", side_1_ships);
const side_2 = new Side(2, "Japan", side_2_ships);
const sides = [side_1, side_2];

// Code to execute
document.getElementById("side_1_name_id").innerHTML = side_1.name;
document.getElementById("side_2_name_id").innerHTML = side_2.name;
display_ships()
</script> 
</body>
</html>
