<!DOCTYPE html>
<html>
<head>
<style>
/* Columns */
* {
  box-sizing: border-box;
}
.column {
  float: left;
  width: 50%;
  padding: 10px;
  overflow: hidden;
  height: 300px;
}
.row:after {
  content: "";
  display: table;
  clear: both;
}
.ship_name_class {
  line-height: 1px;
}
#combat_log_column {
  line-height: 1px;
}
h3 {
  padding:0px;
  margin:0px;
}
</style>
</head>
<body>
<div class="row">
<div class="column">
<h3 id="side_1_name_id"></h3>
<div>
<p id="side_1_ship_list"></p>
</div>
<h3 id="side_2_name_id"></h3>
<div>
<p id="side_2_ship_list"></p>
</div>
<button type="button" onclick="run_hour()">Do hour</button><br>
<button type="button" onclick="run_simulation()">Run simulation</button>
</div>
<div class="column">
<h3>Combat log</h3>
<div id="combat_log_column">
</div>
</div>
</div>
<div class="row">
<div class="column">
<h3>Add a ship</h3>
<label>Name:</label>
<input type="text" id="ship_name_text"> <br>
<label>Health:</label>
<input type="text" id="ship_health_text"> <br>
<label>Class:</label>
<select id="ship_design_choice">
<option value="0">Fletcher</option>
<option value="1">Fubuki</option>
</select><br>
<label>Side:</label>
<select id="ship_side_choice">
<option value="1" id="side_1_name">1</option>
<option value="2" id="side_1_name">2</option>
</select><br>
<button type="button" onclick="add_ship(document.getElementById('ship_name_text').value, all_ship_classes[document.getElementById('ship_design_choice').value], document.getElementById('ship_health_text').value, document.getElementById('ship_side_choice').value)">Add</button>
</div>
<div class="column">
<h3>Create a class</h3>
<label>Name:</label>
<input type="text" id="class_name_text"> <br>
<label>Health:</label>
<input type="text" id="class_health_text"> <br>
<label>Speed:</label>
<input type="text" id="class_speed_text"> <br>
<label>Light guns:</label>
<select id="class_light_guns_choice">
<option value="0">0</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
</select><br>
<label>Torpedoes:</label>
<select id="class_torpedoes_choice">
<option value="0">0</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
</select><br>
<button type="button" onclick="add_class(document.getElementById('class_name_text').value,document.getElementById('class_health_text').value, document.getElementById('class_speed_text').value, document.getElementById('class_light_guns_choice').value, document.getElementById('class_torpedoes_choice').value)">Add</button>
</div>
</div>
<script>
// Define classes
class Side {
	constructor(id, name, ships) {
    	this.id = id;
    	this.name = name;
    	this.ships = ships;
    }
}
class ShipClass {
	constructor(name, base_health, speed, weapons) {
    	this.name = name;
        this.base_health = base_health;
        this.speed = speed;
        this.weapons = weapons;
        this.visibility = 10;
        this.profile = (100 * this.visibility)/(0.5 * this.speed + 20);
    }
}
class Ship {
	constructor(name, design) {
    	this.name = name;
        this.design = design;
        this.health = design.base_health;
    }
}
class Weapon {
	constructor(name, hit_profile, light_attack, torpedo_attack) {
    	this.name = name;
        this.hit_profile = hit_profile;
        this.light_attack = light_attack;
        this.torpedo_attack = torpedo_attack;
    }
}

// Define functions
function get_random(list) {
	return list[Math.floor((Math.random()*list.length))];
}

function run_simulation() {
	while (side_1.ships.length > 0 && side_2.ships.length > 0) {
    	run_hour();
    }
}

function run_hour() {
	// Ships fire
	for (let ship of side_1.ships) {
    	let target = get_random(side_2.ships);
        fire_at_target(ship, target);
    }
    for (let ship of side_2.ships) {
    	let target = get_random(side_1.ships);
        fire_at_target(ship, target);
    }
	// Remove sunken ships
    for (let s of sides) {
      for (let i = 0; i < s.ships.length; i++) {
        if (s.ships[i].health <= 0) {
            // Janky but works
            s.ships.splice(i, 1);
            i -= 1;
            continue;
        }
      }
    }
	// Display ship information
	display_ships()
}

function fire_at_target(ship, target) {
	let hit_chance = 0.1;
    for (weapon of ship.design.weapons) {
      if (target.health > 0 && Math.random() < hit_chance * Math.min((target.design.profile/weapon.hit_profile) ** 2, 1)) {
        target.health -= weapon.light_attack;
        target.health -= weapon.torpedo_attack;
        if (target.health <= 0) {
          add_p_to_beginning("combat_log_column", ship.name + "'s " + weapon.name + " sunk " + target.name);
        } else {
          add_p_to_beginning("combat_log_column", ship.name + "'s " + weapon.name + " hit " + target.name);
        }
      }
    }
}

function display_ships() {
  let paras = document.getElementsByClassName("ship_name_class");
  while(paras[0]) {
    paras[0].parentNode.removeChild(paras[0]);
  }
  for(let s of sides) {
    for (let i = 0; i < s.ships.length; i++) {
      let para = document.createElement("p");
      para.className = "ship_name_class";
      let node = document.createTextNode(s.ships[i].name + " " + s.ships[i].health);
      para.appendChild(node);
      let element = document.getElementById("side_1_ship_list");
      if (s.id == 1) {
      	element = document.getElementById("side_1_ship_list");
      } else if (s.id == 2) {
      	element = document.getElementById("side_2_ship_list");
      }
      element.appendChild(para);
    }
  }
}

function add_p(id, text) {
	let para = document.createElement("p");
    let node = document.createTextNode(text);
    para.appendChild(node);
    let element = document.getElementById(id);
    element.appendChild(para);
}

function add_p_to_beginning(id_container, text) {
	let para = document.createElement("p");
    let node = document.createTextNode(text);
    para.appendChild(node);
    let element = document.getElementById(id_container);
    element.insertBefore(para, element.firstChild);
}

function add_ship(name, design, health, side_id) {
	if (health == 0) {
    	health = design.base_health;
    }
	sides[side_id-1].ships.push(new Ship(name, design, health));
    display_ships();
}

function add_class(name, base_health, speed, light_gun_amount, torpedo_amount) {
	all_ship_classes.push(new ShipClass(name, Number(base_health), Number(speed), Array(light_gun_amount).fill(light_guns)));
    let newOption = new Option(name, all_ship_classes.length-1);
    const select = document.querySelector("#ship_design_choice");
    select.add(newOption, undefined);
}

// Define weaposn
const light_guns = new Weapon("Light Gun", 45, 6, 0);
const torpedoes = new Weapon("Torpedoes", 145, 0, 10);

// Define ship classes
FletcherClass = new ShipClass("Fletcher Class", 50, 36, [light_guns,light_guns,light_guns,light_guns,light_guns,torpedoes,torpedoes]);
FubukiClass = new ShipClass("Fubuki Class", 50, 38, [light_guns,light_guns,light_guns,light_guns,light_guns,torpedoes]);
all_ship_classes = [FletcherClass, FubukiClass];

// Define ships
const side_1_ships = [];
side_1_ships.push(new Ship("Fletcher", FletcherClass));
const side_2_ships = [];
side_2_ships.push(new Ship("Fubuki", FubukiClass), new Ship("Ayanami", FubukiClass));

// Define sides
const side_1 = new Side(1, "America", side_1_ships);
const side_2 = new Side(2, "Japan", side_2_ships);
const sides = [side_1, side_2];

// Code to execute
document.getElementById("side_1_name_id").innerHTML = side_1.name;
document.getElementById("side_2_name_id").innerHTML = side_2.name;
display_ships()
</script> 
</body>
</html>
